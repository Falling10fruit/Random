<!DOCTYPE html>
<html lang = "en">
    <head>
        <meta charset="character_set">

        <title>Number AI detector</title>

        <style>
            body {
                font-family: sans-serif;
                display: flex;
                flex-direction: column;
                justify-content: space-around;
                align-items: center;
            }

            table {
                border-collapse: collapse;
            }

            .Box {
                border: 2px solid black;
            }

            .Control {
                display: flex;
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
        </style>
    </head>
    <body>
        <h1 style="margin: 0px">I make AI</h1>

        <p style="text-align: center; margin: 0px">Go draw numbers from 0 to 9</p>

        <p id="AIGuess" style="margin: 0px">Waiting for input...</p>

        <table>
            <tbody id="Drawing">
            </tbody>
        </table>

        <div class="Control">
            <button type="button" id="Correct">AI correct</button>
            <button type="button" id="Wrong">AI stupid</button>
            <button type="button" id="Reset">Begone ugly drawing</button>
        </div>

        <div class="Control">
            <button type="button" id="Save">SAVE AI brain</button>
            <button type="button" id="Restart">Restart SAVE</button>
            <button type="button" id="Train">Auto train</button>
        </div>

        <script>
            // Setting up body width and margin
            document.body.style.margin = window.innerHeight*0.05 + "px";
            document.body.style.height = window.innerHeight*0.90 + "px";

            // Create Boxes
            for (var i = 0; i < 20; i++) {
                var tr = document.createElement("tr");
                document.getElementById("Drawing").appendChild(tr);
                for (var x = 0; x < 20; x++) {
                    var td = document.createElement("td");
                    td.className = "Box";
                    tr.appendChild(td);
                }
            }

            // Setting Boxes width
            var Boxes = document.getElementsByClassName("Box");

            if (window.innerHeight < window.innerWidth) {
                for (var i = 0; i < Boxes.length; i++) {
                    Boxes[i].style.width = Boxes[i].style.height = window.innerWidth/100 + "px";
                }
            } else {
                for (var i = 0; i < Boxes.length; i++) {
                    Boxes[i].style.width = Boxes[i].style.height = window.innerWidth/100 + "px";
                }
            }

            // Seting up Scene data
            var Scene = [];

            for (var i = 0; i < 20; i++) {
                Scene.push([]);
                for (var x = 0; x < 20; x++) {
                    Scene[i].push(0);
                }
            }

            // Create AI brain
            if (window.localStorage.getItem("SAVEBrain") == null) {
                var Brain = [];

                for (var i = 0; i < 3; i++) { // Two hidden layers and one output layer
                    Brain.push([]);
                    if (i < 2) {
                        for (var x = 0; x < 100; x++) { // 100 Neurons
                            Brain[i].push({
                                Weighs: [],
                                Storage: 0
                            });

                            if (i < 1) {
                                for (var y = 0; y < Boxes.length; y++) { // Connections for first layer
                                    Brain[i][x].Weighs.push(Math.random() * (Math.floor(Math.random() * 3) - 1) + Math.random() * (Math.floor(Math.random() * 3) - 1));
                                }
                            } else {
                                for (var y = 0; y < Brain[i - 1].length; y++) { // Connections
                                    Brain[i][x].Weighs.push(Math.random() * (Math.floor(Math.random() * 3) - 1) + Math.random() * (Math.floor(Math.random() * 3) - 1));
                                }
                            }
                        }
                    } else {
                        for (var x = 0; x < 10; x++) { // 10 output Neurons
                            Brain[i].push({
                                Weighs: [],
                                Storage: 0
                            });

                            for (var y = 0; y < Brain[i - 1].length; y++) { // Connections
                                Brain[i][x].Weighs.push(Math.random() * (Math.floor(Math.random() * 3) - 1) + Math.random() * (Math.floor(Math.random() * 3) - 1));
                            }
                        }
                    }
                }
            } else {var Brain = window.localStorage.getItem("SAVEBrain");}

            // Training
            var Brains = [];
            for (var i = 0; i < 20; i++) { // Generate 20 brains
                Brains.push(Brain);

                for (var x = 0; x < Brains[i].length; x++) { // Layers
                    for (var y = 0; y < Brains[i][x].length; y++) { // Neurons
                        for (var z = 0; z < Brains[i][x][y].Weighs.length; z++) { // Weighs
                            if (Math.floor(Math.random * 100) == 0) {
                                Brains[i][x][y].Weighs[z] += Math.random * 3;
                            }
                        }
                    }
                }
            }

            // AI Brain in action
            var Draw = function (Box) {
                Scene[Math.floor(Box/20)][Box%20] = 1;
                Boxes[Box].style.backgroundColor = "rgb(0, 0, 0)";

                // Resseting the brains
                for (let i = 0; i < Brains.length; i++) { // Brains
                    for (let x = 0; x < Brains[i].length; x++) { // Layers
                        for (let y = 0; y < Brains[i][x].length; y++) { // Neurons
                            Brains[i][x][y].Storage = 0;
                        }
                    }
                }

                // Running the brains
                for (let i = 0; i < Brains.length; i++) { // Brains
                    for (let x = 0; x < Brains[i].length; x++) { // Layers
                        for (let y = 0; y < Brains[i][x].length; y++) { // Neurons
                            if (x < 1) {
                                for (let z = 0; z < Boxes.length; z++) { // Weighs for first layer
                                    Brains[i][x][y].Storage += Brains[i][x][y].Weighs[z] * Scene[Math.floor(z/20)][z%20];
                                }
                            } else {
                                for (let z = 0; z < Brains[i][x - 1].length; z++) { // Weighs
                                    Brains[i][x][y].Storage += Brains[i][x][y].Weighs[z] * Brains[i][x - 1][y].Storage;
                                }
                            }
                        }

                    }
                }

                // Reading First brain output
                var AIGuess = [0, 0];

                
                for (var i = 0; i < Brains[0][Brains[0].length - 1].length; i++) { // First brain's output layer's neurons
                    if (Math.round(Brains[0][Brains[0].length - 1][i].Storage) > AIGuess[0]) {
                        AIGuess[0] = Math.round(Brains[0][Brains[0].length - 1][i].Storage);
                        AIGuess[1] = x;
                    }

                    console.log(i + ": " + Math.round(Brain[Brain.length - 1][i].Storage));
                }

                var AIGuessTxt = document.getElementById("AIGuess");
                AIGuessTxt.innerText = "The AI guesses: " + AIGuess[1];
            }

            var AICorrect = function () {
                // Find AI's Answer
                var AIGuess = [0, 0];
                
                for (var i = 0; i < Brains[0][Brains[0].length - 1].length; i++) { // First brain's output layer's neurons
                    if (Math.round(Brains[0][Brains[0].length - 1][i].Storage) > AIGuess[0]) {
                        AIGuess[0] = Math.round(Brains[0][Brains[0].length - 1][i].Storage);
                        AIGuess[1] = i;
                    }
                }

                //Find all other Brain's answers
                var BrainGuess = [0, 0];

                for (var i = 0; i < Brains.length; i++) { // Check every Brain
                    for (var x = 0; x < Brain[i][Brain[i].length - 1].length; x++) { // Check Brain's output layer's neurons 
                        if (Math.round(Brains[i][Brains[i].length - 1][x].Storage) > AIGuess[0]) {
                            BrainGuess[0] = Math.round(Brains[i][Brains[i].length - 1].Storage);
                            BrainGuess[1] = x;
                        }
                    }

                    if (BrainGuess[1] != AIGuess) { // Kill brain if brain wrong
                        Brains.splice(i, 1);
                    }
                }

                //Regenerate Brains
                for (var i = 0; Brains.length < 20; i++) {
                    Brains.push(Brains[20 - 20%i]);

                    for (var x = 0; x < Brains[Brains.length - 1].length; x++) { // Layers of newly created brain
                        for (var y = 0; y < Brains[Brains.length - 1][x].length; y++) { // Neurons
                            for (var z = 0; z < Brains[Brains.length - 1][x][y].length; z++) { // Weighs
                                Brains[Brains.length - 1][x][y].Weighs[z] += Math.random * (Math.floor(Math.random*3 - 1));
                            }
                        }
                    }
                }
            }

            var AIWrong = function () {
                // Find first Brain's 
                var AIGuess = [0, 0];
                
                for (var i = 0; i < Brains[0][Brains[0].length - 1].length; i++) { // First brain's output layer's neurons
                    if (Math.round(Brains[0][Brains[0].length - 1][i].Storage) > AIGuess[0]) {
                        AIGuess[0] = Math.round(Brains[0][Brains[0].length - 1][i].Storage);
                        AIGuess[1] = i;
                    }
                }

                Brains.splice(0, 1); // Kill first Brain 'cause wrong

                // Find other Brain's anwers
                var BrainGuess = [0, 0];

                for (var i = 0; i < Brains.length; i++) { // Brains
                    for  (var x = 0; x < Brains[i][Brains[i].length - 1].length; x++) { // Neurons at output layer
                        if (Math.round(Brains[i][Brains[i].length - 1][x].Storage) > BrainGuess[0]) {
                            BrainGuess[0] = Math.round(Brains[i][Brains[i].length - 1][x].Storage);
                            BrainGuess[1] = x;
                        }         
                    }

                    if (AIGuess[1] == BrainGuess[1]) { // Kill if wrong
                        Brains.splice(i, 1);
                    }
                }

                //Regenerate Brains
                for (var i = 0; Brains.length < 20; i++) {
                    Brains.push(Brains[20 - 20%i]);

                    for (var x = 0; x < Brains[Brains.length - 1]; x++) {
                        for (var y = 0; y < Brains[Brains.length - 1][x]; y++) {
                            for (var z = 0; z < Brains[Brains.length - 1][x][y].Weighs.length; z++) {
                                Brains[Brains.length.length - 1][x][y].Weighs[z] += Math.random * (Math.floor(Math.random*3 - 1));
                            }
                        }
                    }
                }
            }

            //Clear drawing
            var Clear = function () {
                for (var i = 0; i < Boxes.length; i++) {
                    Boxes[i].style.backgroundColor = "rgb(255, 255, 255)";
                }

                for (var i = 0; i < Scene.length; i++) {
                    for (var x = 0; x < Scene[i].length; x++) {
                        Scene[i][x] = 0;
                    }
                }

                document.getElementById("AIGuess").innerText = "Waiting for input...";
            }

            for (let i = 0; i < Boxes.length; i++) {
                Boxes[i].setAttribute("draggable", false);
                Boxes[i].addEventListener("mousedown", function (e) {
                    Draw(i);
                });
            }

            document.getElementById("Correct").addEventListener("click", AICorrect);

            document.getElementById("Wrong").addEventListener("click", AIWrong);

            document.getElementById("Reset").addEventListener("click", Clear);

            // SAVE AI brain
            document.getElementById("Save").addEventListener("click", function (e) {
                window.localStorage.setItem("SAVEBrain", Brain);
            });
        </script>
    </body>
</html>